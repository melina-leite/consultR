---
title: 'Roteiro 4 - Análises de Diversidade'
author: "Melina Leite"
date: "Departamento de Ecologia IB-USP"
output:
  rmdformats::readthedown:
    highlight: kate
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, echo = F, message = F, cache = F}
knitr::opts_chunk$set(comment = NA, results = 'hide', message = FALSE, eval=FALSE, cache=FALSE, warning=FALSE)

#global options que vieram no rmdformats de html
library(knitr)
library(rmdformats)
library(lattice)
options(max.print="75")
opts_knit$set(width=75)
```

```{r setwd, echo=F}
setwd("../consultR/tutorials")
```

# Análises da riqueza de espécies

Uma forma de caracterizar uma comunidade é simplesemtne contar ou listar as espécies presentes. Parece um procedimento fácil e objetivo descrever e comparar comunidades por meio de suas 'riquezas' em espécies. Na prática, entretanto, isso é surpreendentemente difícil, porque em geral apenas um subamostra dos organismos em uma área pode ser contada. O número de espécies depende do número de amostrar obtidas, então quando devemos cessar a amostragem? Idealmente até que o número de espécies alcance um platô. A riqueza de espécies em diferentes comunidades deve ser comparada usando-se um mesmo tamanho de amostragem.


## Tabelas de dados

Diferentes programas estatísticos requerem dados em diferentes formatos. Neste roteiro, iremos utilizar alguns pacotes (`BiodiversityR` e `vegan`) para análises de diversidade que requerem um formato específico para os dados de abundâncias de espécies (a matriz de espécies por local) e os dados de características ambientais dos locais (a matriz das variáveis de local).

Para a matriz de espécies, colocamos os locais em linhas e as espécies nas colunas.

Vamos usar os dados de vegetação de dunas disponíveis no pacote vegan:
```{r}
library(vegan)
data(dune)
dune
```

Vemos que estes dados tem 30 espécies (colunas), em 20 locais (linhas). Veja o `help(dune)` dos dados para entender melhor de onde vieram. 

A matriz dos dados ambientais, com 5 variáveis, é:
```{r}
data("dune.env")
dune.env
str(dune.env)
```

Nunca se esqueça de fazer uma inspeção nas tabelas de dados. Reveja o [roteiro 2](https://melinatarituba.github.io/consultR/tutorials/tutorial2) sobre análises exploratórias de dados para inspecionar e visualizar graficamente seus dados.


## Construindo a curva de acumulação de espécies

Curvas de acumulação de espécies, algumas vezes chamadas de **curva do coletor**, são representações gráficas que demonstram o número acumulado de espécies registradas (S) em função do esforço amostral (n). O **esforço amostral** pode ser o número de indivíduos coletados, ou uma medida tal como o número de amostras (e.g., quadrados) ou tempo amostral (e.g., meses). Se as curvas de acumulação de espécies atingem um ponto em que o aumento do esforço de coleta não implica num aumento no número de espécies, isto significa que aproximadamente toda a riqueza da área foi amostrada.

Dependendo do protocolo de amostragem usado para o levantamento da riqueza de espécies podemos criar uma curva **baseada em indivíduo**, ou **baseada em amostra**. Tendo como exemplo a amostragem de árvores numa floresta, na abordagem baseada em indivíduo, as árvores seriam amostrados aleatoriamente dentro de cada parcela e registrados sequencialmente. Na abordagem baseada em amostra, as parcelas teriam seu número de espécies e identidades registrados para toda a parcela e acumularíamos o número total de espécies a cada parcela amostrada. A chave da distinção das duas abordagens é a unidade de replicação: o indivíduo vs. uma amostra de indivíduos. 

Para construir a curva do coletor vamos usar o pacote `BiodiversityR`, que além de poder ser usado diretamente no R, tem também uma interface amigável através do pacote `Rcmdr`. Veja o manual do pacote [aqui](http://www.worldagroforestry.org/downloads/Publications/PDFS/b13695.pdf). 

Abaixo a curva do coletor (**baseada em amostra**) para os dados de vegetação das dunas:
```{r}
library(BiodiversityR)
Accum <- accumresult(dune, method='collector')
Accum
accumplot(Accum)
```

A curva acima pode se considerada a curva "bruta", onde a riqueza de espécies foi plotada de acordo com a ordem dos locais amostrados. 

[Colwell & Coddington (1994)](http://staff.washington.edu/mchd/FISH513/Papers/Colwell_Coddington_94.pdf) sugeriram um método que consiste em montar várias curvas adicionando-se as amostras em uma ordem aleatória. Após construir várias curvas com este método, pode-se calcular uma curva do coletor média (baseada na riqueza média para cada número de amostra) e expressar a variação possível em torno dessa média. Isso pode ser feito de duas maneiras. A primeira é utilizando a riqueza média agrupada quando 1,2... todos os locais são combinados juntos. A razão para calcular a **riqueza agrupada média de espécies** é que diferentes combinações vão ter diferentes riquezas. Por exemplo, nestes dados o local 1 contém 5 espécies, enquanto que o local 2 e 3 contém 10 espécies. Em outras palavras, nao existe um valor único para a riqueza de espécies em UM local e por isso, o valor médio é calculado. 

```{r}
Accum.1 <- accumresult(dune, method='exact')
Accum.1
accumplot(Accum.1)
```

O resultado de `Accum.1` mostra que a riqueza média para todas as possíveis combinações de 14 locais é 28.85, equanto que para todas as possíveis combinações de 17 locais é 29.51. O `sd` indica o desvio padrão observado, já que algumas combinações de locais contém menores número de espécies e outras combinações maiores. 

Os resultados acima são baseados nos cálculos exatos da riqueza de espécies média para combinações de locais. Outra forma de fazer isso é aproximar essa riqueza média de espécies em uma abordagem de aleatorização. Por exemplo, para encontrar uma estimativa da riqueza média para 3 locais, selecionamos 3 locais aleatoriamente de todos os 30 locais. Calcumamos a riqueza de espécies e então selecionamos outros 3 locais aleatoriamente. Repetimos isso umas 1000 vezes e pegamos a média de todas estas estimativas. 

Os resultados da curva de acumulação de espécies baseado nesta aleatorização para as espécies das dunas será:

```{r}
Accum.2 <- accumresult(dune, method='random', permutations=1000)
Accum.2
accumplot(Accum.2)
```

Para alguns conjuntos de dados, a informação não é coletada por local, e sim por indivíduo observado. Frequentemente, levantamentos de vertebrados são obtidos dessa maneira, registrando as informações das espécies para cada indivíduo observado sequencialmente. Neste caso devemos calcular a curva de acumulação **baseada em indivíduo**. 

Vejamos a curva **baseada em indivíduo** para os dados das dunas:
```{r}
# primeiro sabendo o número de indivíduos em cada site
 dune.env$site.totals <- apply(dune,1,sum)

# depois usando isso como 'scale' na curva:
Accum.5 <- accumresult(dune, y=dune.env, scale='site.totals', method='rarefaction')
Accum.5
accumplot(Accum.5, xlab='pooled individuals')
```

Neste gráfico percebemos que os resultados não indicam todas as 685 possíveis combinações de indivíduos. Os resultados foram reportados apenas para o número médio de indivíduos em cada local, 685/20 = 34.25 (arredondando para 34 indivíduos). 

## Usando a curva de acumulação de espécies para comparar riqueza total de subgrupos de dados

As curvas de acumulação de espécies são especialmente úteis quando comparamos a riqueza de espécies para subgrupos nos dados quando os tamanhos amostrais são diferentes destes subgrupos.

Quando calculamos a curva de acumulação de espécies para cada categoria de manejo dos dados das dunas (tabela de variáveis ambientais, coluna `management`):
```{r}
Accum.6 <- accumcomp(dune, y = dune.env, factor = 'Management', method = 'exact', legend = F)
Accum.6
```

Olhando para o gráfico acima, podemos observar uma riqueza de espécies de 16 para um tamanho amostral de 3 locais no manejo o "BF", e uma riqueza total de 21 para um tamanho amostral de 5 locais para o manejo "HF". Os resultados agora permitem comparar a riqueza de espécies em um mesmo tamanho amostral. Por exemplo, quando comparamos as 4 categorias de manejo no tamanho amostral 3, vemos que HF tem uma maior riqueza de espécies do que as outras 3 categorias. 


## Estimando o número total de espécies da área

Na maioria das situações, nós registramos o número de espécies de uma quantitade de locais que não cobre toda a área que estamos interessados. Nós não saberemos a composição de espécies das áreas que não amostramos.

Diversas fórmulas já foram desenvolvidas para estimar o número total de espécies de uma área. Em termo de curvas de acumulação de espécies, nós precisamos extrapolar a curva até o ponto do eixo x que corresponde ao tamanho total da área. Estes métodos de estimação são baseados em diferentes premissas sobre como as espécies se acumulam além da área amostrada. Provavelmente um método vai ser ais preciso e uma situação, e outro em outra. 

Se queremos fazer esta extrapolação, então a melhor abordagem é reportar a variação nos valores obtidos com os diferentes métodos e esperar que o valor total correto esteja dentro desse intervalo. 

Para os dados das dunas, fizemos a predições da riqueza total de espécies usando 4 estimadores diferentes:

```{r}
Diversity.5 <- diversityresult(dune, index='jack1')
Diversity.5

Diversity.6 <- diversityresult(dune, index='jack2')
Diversity.6

Diversity.7 <- diversityresult(dune, index='chao')
Diversity.7

Diversity.8 <- diversityresult(dune, index='boot')
Diversity.8
```

Podemos ver que as estimativas foram similares, variando entre 31-34 espécies. Isso não nos surpreende, pois já vimos que o formato da nossa curva de acumulação de espécies praticamente atingia um platô, sugerindo que a amostragtem conseguiu capturar quase toda as espécies da área de estudo. 




# Análises de diversidade em comunidades

Um aspecto importante da estrutura de comunidades é completamente ignorado quando a composição da comunidade é descrita simplesemente em termos do número de espécies (riqueza). Ignora-se a informação de que algumas espécies são raras outra bem comuns. A diversidade, através de índices, incorpora a riqueza, dominância e raridade na comunidade. 

Muitas vezes estamos interessados em comparar a diversidade em diferentes locais, por exemplo saber a se a diversidade é maior no local A em relação ao local B. Para isso geralmente utilizamos índices de diversidade que seja capazes de capturar a riqueza e a equabilidade das espécies na comunidade em um único valor.

Vejamos um exemplo: o local A tem 3 espécies, enquanto o local B tem 5 espécies, logo local B tem maior riqueza de espécies do que o A. Agora imagine os locais C e D, ambos com 3 espécies. Porém o local C contém 4 indivíduos da espécie 1, 1 da espécie 2 e 1 da espécie 3, enquanto que o local D tem 2 indivíduos de cada espécie. Nessa situação D tem maior equabilidade, o que significa que a proporção de indivíduos nas espécies é mais similar.



## Índice de Simpson

A medida mais simples para caracterizar a comunidade, e que leva em consideração tanto o padrão de abundância quanto a riqueza de espécies é o **Índice de diversidade de Simpson**. Ele é calculado obtendo-se para casa espécie a proporção de indivíduos em relação ao total da amostra, ou seja, a proporção $P_i$ para a _i_-ésima espécie. Pode ser calculado de duas formas:

$$ D_1 = 1 - \sum_{i=1}^S P_i^2 $$

ou o inverso do Simpson:

$$ D_2 = \frac{1}{\sum_{i=1}^S P_i^2} $$

em que $S$ é a riqueza de espécies na comunidade. Para uma dada riqueza, $D$ aumenta com a equabilidade (ou equitabilidade, o contrário de dominância), e para uma dada equabilidade, $D$ aumenta com a riqueza. 

A equabilidade também pode ser quantificada (entre 0 e 1), obtendo-se a proporção entre o índice de Simpson e o valor máximo que este assumiria caso os indivíduos fossem distribuídos uniformemente entre as espécies. $D_max = S$, portanto:

$$ E = \frac{D} {D_{max}} = \frac{1}{\sum_{i=1}^S P_i^2} x \frac{1}{S}$$

O índice de Simpson também é conhecido como índice de Dominância. Sua interpretação é simples e ele significa a probabilidade de 2 indivíduos sorteados de uma comunidade pertencerem à mesma espécie. É considerado um índice robustro e significartivo, captura bem a variação das distribuições de abundância e ele estabiliza com menores tamanhos amostrais. Porém é um índice que não dá muito peso à espécies raras, portanto inadequado para comunidades com muitas espécies raras (geralmente o caso dos ambientes tropicais).


No R podemos usar a função `diversity` do pacote `vegan`, ou `diversityresult` do pacote `BiodiversityR` (que é mais diverso mas também usa a função `diversity`). Abaixo, colocando a matriz de espécies obtemos um índice para cada local:
```{r}
# Simpson 1-D
diversity.simp <- diversity(dune, index='simpson')
diversity.simp

# inverso de simpson:
diversity.invsimp <- diversity(dune, index='invsimpson')
diversity.invsimp

# usando pacote BiodiversityR
Diversity.2 <- diversityresult(dune, index='Simpson' , method='s')
Diversity.2
```

Mas também podemos obter o índica para todos os locais agrupados:
```{r}
divers.all <- diversityresult(dune, index = "Simpson", method='all')
divers.all
```



## Índice de Shannon


Um outro índice frequentemente utilizado e que possui essencialmente as mesmas propriedades é o de **Shannon**, $H$. 

$$diversidade  H = -\sum{i=1}^S P_i lnP_i $$

Cuja equabilidade é:

$$J = \frac{H} {H_{max}} = \frac{-\sum{i=1}^S P_i lnP_i} {lnS} $$

onde $ln$ significa o logarítimo de base natural $e$. 

Cabe lembrar que os índices descritos acima levam em consideração a riqueza e a equabilidade e se aplicam a amostras da comunidade. As premissas desses índices são de que a comunidade é infinitamente grande (amostras grandes e representativas), e que os indivíduos são amostrados aleatoriamente. 

Para o **índice de Shannon**, as características mais atrativas são:

- Índice mais utilizado na literatura

- Geralmente valores entre 1.5 e 3.5 (raramente acima de 5)

- É sensível à espécies raras 

- É sensível a variações nas abundâncias


Para calcular o índice de Shannon, usamos as mesmas funções no R, mudando apenas o argumento `index`:
```{r}
diversity.sha <- diversity(dune, index='shannon')
diversity.sha

diversity.sha2 <- diversityresult(dune, index='Shannon', method='s')
diversity.sha2


# Equabilidade de Shannon:
diversity.shaE <- diversityresult(dune, index='Jevenness', method='s')
diversity.shaE

```


## Índice de Dominância de Berger-Parker ($d$)

Este índice é geralmente recomendado por ser intuitivamente simples e fácil de calcular e por significado biológico:

$$ d = \frac{N_{max}}{N} $$

onde $N_{max}$ é o número de indivíduos da espécie mais abundante e $N$ é o número total de indivíduos da comunidade.

Porém é um índice problemático apra comunidades com poucas espécies (S<15 espécies). 

```{r}
diversity.ber <- diversityresult(dune, index='Berger', method='s')
diversity.ber
```




## Perfil de diversidade de Rényi

Perfis de diversidade de Rényi são curvas que provém informação sobre a riqueza e equabilidade das espécies. Esta é uma técnica de ordenação da diversidade.   
O formato da curva é o indicativo da equabilidade. Uma linha horizontal indica que todas as espécies tem o mesmo número de indivíduos. Quanto menos horizontal um perfil é, menos equitativa é a distribuição das espécies. O início da curva à esquerda é um indicativo da riqueza de espécies. Perfis que iniciam em um alto nível tem maior riqueza.  

Uma vantagem do perfi de Rényi é que os locais podem ser facilmente ordenados da maior para a menor diversidade. Se o perfil de um local está sempre acima de outro, então este é mais diverso que o segundo. Mas se os perfis se cruzam, é provável que um local tenha mais riqueza, enquanto outro mais equabilidade. 

Para obter mais detalhes de como o perfi de Rényi é calculado veja o Capítulo 5 do manual do pacote [BidiversityR](http://www.worldagroforestry.org/downloads/Publications/PDFS/b13695.pdf) (esse manual é muito bom para todo o tipo de análise de diversidade).

Os índices de diversidade são um método mais compacto de comparar diversidades. Porém, um índice de diversidade frequentemente não irá prover a informação suficiente para ordenar locais da maior para menor diversidade. Apenas técnicas de ordenação da diversidade, como o perfil de Rényi, nos permitirá concluir que um local é mais diverso que o outro. 

Calculando o perfil de diversidade de Rényi para os dados da vegetação de dunas:
```{r}
Renyi.1 <- renyiresult(dune)
Renyi.1
#gráfico do perfil de diversidade
renyiplot(Renyi.1,legend=F)

#gráfico do perfil de equitabilidade
renyiplot(Renyi.1, evenness=TRUE, legend=F)

# Calculando o perfil para cada local separadamente:
Renyi.2 <- renyiresult(dune, method='s')
Renyi.2
renyiplot(Renyi.2, legend=F)
renyiplot(Renyi.2, evenness=TRUE, legend=F)
```


De maneira similar às comparações de riqueza de espécies, precisamos ser cautelosos ao comparar a diversidade total de vários subgrupos nos dados se os subgrupos contém tamanho amostral diferente. Assim como para riqueza de espécies, os índices de diversidade também vão mudar quando o tamanho amostral aumenta. 

Se queremos comparar a diversidade total de subgrupos nos dados, precisamos calcular a diversidade com mesmo tamanho amostral. Um procedimento similar àquele usado para curvas de acumulação de espécies pode ser usado. Isso envolve pegar subgrupos aleatórios dos dados e calcular o perfil de diversidade para  subgrupo. Pelas reamostragens aleatórias poderemos criar perfis de diversidade médias. 

Para calcular a diversidade das diferentes categorias de manejo dos dados das dunas, precisamos comaprar a diversidade usando o número de amostras da categoria de menor tamanho amostral (no nosso caso HF - 3 amostras). 

Para comparar a diversidade entre subgrupos dos dados usando o perfil de Rényi:
```{r}
Renyi.3 <- renyicomp(dune, y = dune.env, factor = 'Management', permutations = 100, legend = F)
Renyi.3
```










## Rarefação

- artigo pacote Rich

( apostila UNESP:)
Esse método nos permite comparar o número de espécies entre comunidades quando o tamanho da amostra ou o número de indivíduos (abundância) não são iguais. A rarefação calcula o número esperado de espécies em cada comunidade tendo como base comparativa um valor em que todas as amostras atinjam um tamanho padrão, ou comparações baseadas na menor amostra ou com menos indivíduos (dentre todas amostras possíveis). Se considerarmos n indivíduos (n < N) para cada comunidade, quantas espécies iríamos registrar?
!(!)= 1− (!− !!)/! !/!
Onde:
E(S) = Número de espécies esperado
N = Número total de indivíduos na amostra
Ni = Número de indivíduos da iésima espécie
n = tamanho da amostra padronizada (menor amostra)
Gotelli & Collwel (2001) descrevem este método e discutem em detalhes as restrições sobre seu uso na ecologia: i) as amostras a serem comparados devem ser consistentes do ponto de vista taxonômico, ou seja, todos os indivíduos devem pertencer ao mesmo grupo taxonômico; ii) as comparações devem ser realizadas somente entre amostras com as mesmas técnicas de coleta; iii) os tipos de hábitat onde as amostras são obtidas devem ser semelhantes; e iv) é um método para estimar a riqueza de espécies em uma amostra menor – não pode ser usado para extrapolar e estimar riqueza.





# Análises das diferenças na composição de espécies

Veremos a partir de agora como as diferenças na composição de espécies pode ser investigada através do cálculo das distâncias ecológicas entre dois locais. Os métodos podem ser aplicados à matriz inteira de espécies, resultando então em uma outra matriz de distância (ou similaridade) entre os pares de locais. 
## Distância Ecológica

Uma boa medida de distância ecológica descreve a diferença na composição de espécies de forma que locais que compartilhem muitas espécies devem ter distância ecológica pequena. Existe na literatura uma grande variedade de distâncias, apresentamos aqui as mais utilizadas para dados ecológicos.

### Distância Euclidiana

A distância euclidiana é calculada usando cada espécie como um eixo diferente em um gráfico (número de dimensões igual à riqueza total). Os locais são plotados neste gráfico multidimensional para que as distâncias entre os locais sejam calculadas. 

A distância euclidiana não é uma boa distância ecológica para dados brutos da matriz de espécie - com as abundâncias de cada espécie em cada local. Portanto, o que se recomenda é transformar a matriz de espécies, por exemplo padronizando os dados antes de calcular as distâncias. 


## Análise de componentes principais (PCA)

## Escalonamento multidimensional não paramétrico (NMDS)



# Material Extra:

- Livro-manual que acompanha o pacote [biodiversityR](http://www.worldagroforestry.org/downloads/Publications/PDFS/b13695.pdf) 

- [Roteiro](https://cran.r-project.org/web/packages/vegan/vignettes/diversity-vegan.pdf) do pacote `vegan` sobre Diversidade Ecológica, contendo os índices, as curvas de acumulação de espécies e rarefação. 

- [Roteiro](https://dl.dropboxusercontent.com/u/6511995/veganbird.pdf) do pacote vegan sobre ordenação e análise de dissimilaridade.

- Roteiros sobre PCA no R, [aqui](http://www.dataperspective.info/2016/02/principal-component-analysis-using-r.html), [aqui](https://tgmstat.wordpress.com/2013/11/21/introduction-to-principal-component-analysis-pca/) e [aqui](https://tgmstat.wordpress.com/2013/11/28/computing-and-visualizing-pca-in-r/).

